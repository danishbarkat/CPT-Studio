<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT Studio | Physician-Ready Pricing</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #0f172a;
            --slate: #334155;
            --muted: #64748b;
            --marine: #0369a1;
            --marine-light: #e0f2fe;
            --teal: #0284c7;
            --teal-gradient: linear-gradient(135deg, #0ea5e9, #38bdf8);
            --mint: #10b981;
            --mint-light: #d1fae5;
            --rose: #e11d48;
            --rose-light: #ffe4e6;
            --sand: #f8fafc;
            --paper: #fdfdfd;
            --card: transparent;
            --border: rgba(226, 232, 240, 0.4);
            --shadow-sm: 0 4px 12px -2px rgba(15, 23, 42, 0.03), 0 2px 8px -2px rgba(15, 23, 42, 0.02);
            --shadow-md: 0 16px 32px -4px rgba(14, 165, 233, 0.04), 0 8px 16px -4px rgba(15, 23, 42, 0.03);
            --shadow-lg: 0 24px 48px -12px rgba(14, 165, 233, 0.1), 0 12px 24px -12px rgba(15, 23, 42, 0.06);
            --shadow-xl: 0 32px 64px -12px rgba(3, 105, 161, 0.12), 0 16px 32px -16px rgba(15, 23, 42, 0.08);
            --hover-lift: translateY(-4px);
            --transition-bounce: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--paper);
            color: var(--ink);
            line-height: 1.6;
            padding: 40px 60px;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Deep, Ambient Background Mesh */
        body::before {
            content: '';
            position: fixed;
            top: -20%;
            left: -10%;
            width: 120%;
            height: 140%;
            background:
                radial-gradient(ellipse at 15% 10%, rgba(14, 165, 233, 0.12), transparent 45%),
                radial-gradient(ellipse at 85% 80%, rgba(16, 185, 129, 0.08), transparent 50%),
                radial-gradient(ellipse at 50% -20%, rgba(3, 105, 161, 0.1), transparent 60%);
            z-index: -1;
            pointer-events: none;
            filter: blur(40px);
        }

        h1,
        h2,
        h3,
        h4 {
            letter-spacing: -0.04em;
            line-height: 1.1;
            color: var(--ink);
        }

        .page {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 60px;
            position: relative;
            z-index: 1;
            padding-bottom: 80px;
        }

        /* Open Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--marine);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .brand-mark {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--teal-gradient);
            display: grid;
            place-items: center;
            color: white;
            font-weight: 800;
            font-size: 1.4rem;
            box-shadow: 0 8px 16px -4px rgba(2, 132, 199, 0.4);
            transition: var(--transition-bounce);
        }

        header:hover .brand-mark {
            transform: scale(1.05) rotate(5deg);
        }

        .pill {
            background: transparent;
            color: var(--slate);
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        /* Minimal Hero */
        .hero {
            padding: 20px 0 60px 0;
            position: relative;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 28px;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 16px;
            background: linear-gradient(to right, var(--ink), var(--marine));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            max-width: 800px;
        }

        .hero p {
            color: var(--slate);
            font-size: 1.3rem;
            font-weight: 500;
            max-width: 600px;
        }

        .hero-stats {
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
            margin-top: 40px;
        }

        .stat-chip {
            padding-right: 32px;
            border-right: 1px solid var(--border);
        }

        .stat-chip:last-child {
            border-right: none;
        }

        .stat-chip strong {
            display: block;
            font-size: 1.8rem;
            color: var(--marine);
            font-weight: 800;
            line-height: 1.1;
        }

        .stat-chip span {
            color: var(--muted);
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .steps {
            display: flex;
            gap: 24px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .step {
            color: var(--teal);
            font-weight: 700;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Floating Configuration Bar */
        .config-bar {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 100px;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 32px;
            font-size: 1.05rem;
            color: var(--slate);
            box-shadow: var(--shadow-lg);
            margin: -30px auto 40px auto;
            width: fit-content;
        }

        .config-bar span {
            font-weight: 800;
            color: var(--ink);
        }

        .config-bar select {
            appearance: none;
            background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%2364748b" viewBox="0 0 16 16"><path d="M4.293 6.293a1 1 0 011.414 0L8 8.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/></svg>') no-repeat right 12px center;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 36px 8px 14px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--ink);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-smooth);
        }

        .config-bar select:hover,
        .config-bar select:focus {
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
            outline: none;
        }

        /* Custom Toggle */
        .toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 700;
        }

        .toggle input {
            display: none;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: var(--slate);
            border-radius: 20px;
            position: relative;
            transition: var(--transition-smooth);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            transition: var(--transition-bounce);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle input:checked+.toggle-slider {
            background: var(--mint);
        }

        .toggle input:checked+.toggle-slider::after {
            left: calc(100% - 21px);
        }

        /* Floating Source Elements Drop shadow style */
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 48px;
        }

        /* Unboxed Cards */
        .card {
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: transparent;
            padding: 10px;
        }

        .card h3 {
            font-size: 1.8rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--ink);
            margin-bottom: 8px;
        }

        .source-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .panel-header {
            display: none;
        }

        /* Kept for legacy compat if needed, but we style card h3 instead */

        /* Inputs (Soft floating) */
        input[type="text"] {
            width: 100%;
            padding: 18px 24px;
            border-radius: 20px;
            border: none;
            background: #fff;
            font-family: inherit;
            font-size: 1.1rem;
            color: var(--ink);
            transition: var(--transition-bounce);
            box-shadow: var(--shadow-md);
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: var(--shadow-xl), 0 0 0 4px rgba(14, 165, 233, 0.15);
            transform: var(--hover-lift);
        }

        .file-input {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 48px 32px;
            transition: var(--transition-bounce);
            text-align: center;
            position: relative;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .file-input:hover {
            background: #fff;
            box-shadow: var(--shadow-lg);
            transform: var(--hover-lift);
        }

        .file-input .file-label {
            display: inline-block;
            background: var(--teal-gradient);
            color: #fff;
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 1.05rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition-bounce);
            margin: 0 auto;
        }

        .file-input:hover .file-label {
            box-shadow: 0 12px 24px rgba(2, 132, 199, 0.3);
            transform: translateY(-2px);
        }

        .file-input input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input .file-hint {
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 600;
        }

        .divider {
            text-align: center;
            color: var(--muted);
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            margin: 4px 0;
            text-transform: uppercase;
        }

        /* Buttons - Floating styling */
        button {
            border: none;
            border-radius: 20px;
            padding: 16px 28px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition-bounce);
            background: var(--teal-gradient);
            color: white;
            box-shadow: var(--shadow-md);
            flex: 1;
        }

        button:hover:not(:disabled) {
            transform: var(--hover-lift);
            box-shadow: var(--shadow-xl);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--sand);
            color: var(--muted);
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .primary-button {
            background: var(--teal-gradient);
        }

        .warning-button {
            background: linear-gradient(135deg, #f97316, #ea580c);
            box-shadow: 0 4px 14px 0 rgba(249, 115, 22, 0.35);
        }

        .warning-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px 0 rgba(249, 115, 22, 0.45);
        }

        .cta-button {
            padding: 18px 48px;
            font-size: 1.25rem;
            border-radius: 30px;
        }

        .success-button {
            background: linear-gradient(135deg, var(--mint), #059669);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.35);
        }

        .success-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.45);
        }

        .download-button {
            background: linear-gradient(135deg, var(--mint), #059669);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.35);
            width: auto;
            flex: none;
        }

        .download-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.45);
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            margin-top: auto;
            padding-top: 10px;
        }

        .compare-action {
            display: flex;
            justify-content: center;
            margin: 40px 0;
            position: relative;
            z-index: 2;
        }

        .note {
            margin: 24px 0;
            padding: 18px 24px;
            border-radius: 20px;
            background: rgba(249, 115, 22, 0.05);
            border-left: 4px solid #ea580c;
            color: #c2410c;
            font-size: 1.05rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        /* Airy Results Flow */
        .results-wrapper {
            margin-top: 60px;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .result-item {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 32px;
            box-shadow: var(--shadow-lg);
        }

        .result-item h4 {
            margin-bottom: 24px;
            font-weight: 800;
            font-size: 1.6rem;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Deep Stats Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 32px;
            margin: 40px 0;
        }

        .stat-card {
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            background: #fff;
            box-shadow: var(--shadow-md);
            transition: var(--transition-bounce);
        }

        .stat-card:hover {
            transform: var(--hover-lift);
            box-shadow: var(--shadow-md);
        }

        .stat-card h4 {
            color: var(--slate);
            font-size: 1.05rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .stat-value {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1.1;
            color: var(--teal);
        }

        /* Table */
        .cpt-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 16px;
            font-size: 0.95rem;
        }

        .cpt-table th {
            background: var(--sand);
            padding: 14px 16px;
            text-align: left;
            color: var(--slate);
            font-weight: 800;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.8rem;
        }

        .cpt-table th:first-child {
            border-top-left-radius: 12px;
        }

        .cpt-table th:last-child {
            border-top-right-radius: 12px;
        }

        .cpt-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            color: var(--slate);
            vertical-align: top;
        }

        .cpt-table tbody tr {
            transition: background 0.2s ease;
        }

        .cpt-table tbody tr:hover {
            background: rgba(241, 245, 249, 0.6);
        }

        .cpt-table tbody tr:last-child td {
            border-bottom: none;
        }

        .price-higher {
            color: var(--rose);
            font-weight: 800;
        }

        .price-lower {
            color: var(--mint);
            font-weight: 800;
        }

        /* URL List && Pagination */
        .url-list {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 12px;
        }

        .url-item {
            background: var(--sand);
            padding: 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 1px solid transparent;
            word-break: break-all;
        }

        .url-item:hover {
            background: #fff;
            border-color: var(--teal);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .url-item strong {
            display: block;
            margin-bottom: 4px;
            color: var(--ink);
        }

        .url-item small {
            color: var(--muted);
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding: 20px 32px;
            background: #fff;
            border-radius: 100px;
            font-weight: 700;
            color: var(--marine);
            box-shadow: var(--shadow-md);
        }

        .pagination-controls button {
            width: auto;
            padding: 10px 20px;
            font-size: 0.9rem;
            background: #fff;
            color: var(--ink);
            box-shadow: var(--shadow-sm);
            flex: none;
        }

        /* Loading Overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 4px solid var(--border);
            border-top-color: var(--teal);
            animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading h3 {
            color: var(--marine);
            font-size: 1.4rem;
            font-weight: 800;
        }

        /* Alerts Container */
        .alerts-container {
            position: fixed;
            top: 30px;
            right: 40px;
            z-index: 1000;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #alerts {
            position: fixed;
            top: 30px;
            right: 40px;
            z-index: 1000;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Support for original #alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-size: 0.95rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            box-shadow: var(--shadow-md);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-error {
            background: var(--rose-light);
            color: #9f1239;
            border: 1px solid #fda4af;
        }

        .alert-success {
            background: var(--mint-light);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }

        @media (max-width: 900px) {
            body {
                padding: 20px;
            }

            .hero h1 {
                font-size: 2.2rem;
            }

            .grid,
            .source-grid {
                grid-template-columns: 1fr;
            }

            .alerts-container,
            #alerts {
                right: 20px;
                left: 20px;
                max-width: none;
            }

            .compare-action button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <div class="brand-mark">C</div> CPT Studio
        </div>
        <span class="pill">Physician-grade pricing clarity</span>
    </header>
    <div class="page">
        <div class="hero">
            <div class="hero-grid">
                <div>
                    <h1>Side-by-side CPT pricing doctors can trust.</h1>
                    <p>Upload payer files, stream giant JSONs, or pull payer URLs. We‚Äôll surface deltas, savings, and
                        outliers so clinicians get quick answers during consults.</p>
                    <div class="hero-stats">
                        <div class="stat-chip"><strong>3 steps</strong><span>Load ¬∑ Compare ¬∑ Export</span></div>
                        <div class="stat-chip"><strong>300MB+</strong><span>Handles split files safely</span></div>
                        <div class="stat-chip"><strong>Live CSV</strong><span>One-click export</span></div>
                    </div>
                </div>
                <div>
                    <div class="steps">
                        <div class="step">1. Label your sources</div>
                        <div class="step">2. Upload file or paste URL</div>
                        <div class="step">3. Compare & export for rounds</div>
                        <div class="step"
                            style="background: rgba(16,185,129,0.08); color:#0f9d7a; border-color: rgba(16,185,129,0.15);">
                            Bonus: Auto-preview giant files</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card upload-card">
            <h3>Load your sources</h3>
            <p>Clinician-friendly labels, generous file sizes, and URL ingestion. Source 1 supports split parts for huge
                JSON exports.</p>
            <div class="source-grid">
                <div class="source-panel">
                    <div class="panel-header"><span class="dot"></span><span>Source 1</span></div>
                    <input type="text" id="source1-name" placeholder="e.g., Blue Cross IL" aria-label="Source 1 name">
                    <label class="file-input">
                        <span class="file-label">Choose file</span>
                        <input type="file" id="source1-file" accept=".json,.csv,.xlsx,.xls">
                        <span class="file-hint" id="source1-file-hint">No file chosen</span>
                    </label>
                    <label class="file-input">
                        <span class="file-label">Add split parts (multi-select)</span>
                        <input type="file" id="source1-parts" accept=".json,.gz" multiple>
                        <span class="file-hint" id="source1-parts-hint">Upload 300MB parts here</span>
                    </label>
                    <div class="divider">OR</div>
                    <input type="text" id="source1-url" placeholder="Enter JSON URL" aria-label="Source 1 URL">
                    <div class="actions">
                        <button class="primary-button" onclick="uploadSource(1)">Load Source 1</button>
                        <button class="warning-button" onclick="uploadSource1Parts()">Upload Parts</button>
                        <button class="cta-button" onclick="finalizeSource1Parts()">Finalize Parts</button>
                    </div>
                </div>

                <div class="source-panel">
                    <div class="panel-header"><span class="dot"
                            style="background:#10b981; box-shadow:0 0 0 8px rgba(16,185,129,0.14);"></span><span>Source
                            2</span></div>
                    <input type="text" id="source2-name" placeholder="e.g., Aetna" aria-label="Source 2 name">
                    <label class="file-input">
                        <span class="file-label">Choose file</span>
                        <input type="file" id="source2-file" accept=".json,.csv,.xlsx,.xls">
                        <span class="file-hint" id="source2-file-hint">No file chosen</span>
                    </label>
                    <div class="divider">OR</div>
                    <input type="text" id="source2-url" placeholder="Enter JSON URL" aria-label="Source 2 URL">
                    <button class="primary-button" onclick="uploadSource(2)">Load Source 2</button>
                </div>
            </div>

            <div class="note">
                <strong>Heads up:</strong> Some payer URLs expire fast. Use test data for demos or fetch a fresh index
                JSON if links time out.
            </div>

            <div class="actions">
                <button class="warning-button" onclick="loadTestData()">üìä Load Test Insurance Data (Source 1)</button>
                <button class="cta-button" onclick="compareSources()">üîç Compare Pricing</button>
            </div>

            <div id="alerts"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing‚Ä¶</p>
            </div>
        </div>

        <div class="card results-wrapper">
            <div class="results-header">
                <div>
                    <h2>Pricing Comparison Results</h2>
                    <p>Totals, outliers, savings ‚Äî built for clinical conversations.</p>
                </div>
                <button class="success-button" id="export-comparison-btn" onclick="exportComparisonData()" disabled>‚¨á
                    Export Comparison CSV</button>
            </div>
            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        let source1Data = null;
        let source2Data = null;
        let loadedSources = new Set();
        let source1Ready = false;
        let source2Ready = false;
        let source1PartSession = null;
        let source1PartCount = 0;
        const PAGE_SIZE = 20;
        const READY_SOURCE_TYPES = new Set(['excel', 'direct_in_network_json', 'csv']);
        const sourceCptState = {};
        const exportComparisonButton = document.getElementById('export-comparison-btn');

        function getSelectedComparisonRule() {
            const el = document.getElementById('comparison-rule');
            return (el && el.value) ? el.value : 'max';
        }

        function getSelectedNegotiatedType() {
            const el = document.getElementById('negotiated-type');
            return (el && el.value) ? el.value : '';
        }

        function getExcludeExpired() {
            const el = document.getElementById('exclude-expired');
            return !!(el && el.checked);
        }

        function ensureComparisonRuleSelector() {
            if (document.getElementById('comparison-rule')) return;
            const header = document.querySelector('.results-header');
            if (!header) return;

            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '10px';
            label.style.flexWrap = 'wrap';

            const title = document.createElement('span');
            title.textContent = 'Comparison Rule';
            title.style.fontWeight = '600';
            title.style.color = 'var(--text-muted)';

            const select = document.createElement('select');
            select.id = 'comparison-rule';
            select.style.padding = '10px 12px';
            select.style.border = '1px solid var(--border)';
            select.style.borderRadius = '10px';
            select.style.background = 'var(--card)';
            select.style.color = 'var(--text-main)';
            select.innerHTML = `
                <option value="max" selected>MAX (worst-case / highest)</option>
                <option value="min">MIN (best-case / lowest)</option>
                <option value="avg">AVG (average)</option>
                <option value="median">MEDIAN (robust)</option>
                <option value="max_avg_by_billing_class">By Billing Class (max avg)</option>
                <option value="all_classes">All Classes (per class compare)</option>
                <option value="per_occurrence">Per Code (highest of repeats)</option>
                <option value="context">Context (class + modifier)</option>
            `;

            label.appendChild(title);
            label.appendChild(select);
            header.insertBefore(label, exportComparisonButton);

            const ntLabel = document.createElement('label');
            ntLabel.style.display = 'flex';
            ntLabel.style.alignItems = 'center';
            ntLabel.style.gap = '10px';
            ntLabel.style.flexWrap = 'wrap';

            const ntTitle = document.createElement('span');
            ntTitle.textContent = 'Negotiated Type';
            ntTitle.style.fontWeight = '600';
            ntTitle.style.color = 'var(--text-muted)';

            const ntSelect = document.createElement('select');
            ntSelect.id = 'negotiated-type';
            ntSelect.style.padding = '10px 12px';
            ntSelect.style.border = '1px solid var(--border)';
            ntSelect.style.borderRadius = '10px';
            ntSelect.style.background = 'var(--card)';
            ntSelect.style.color = 'var(--text-main)';
            ntSelect.innerHTML = `
                <option value="">Any</option>
                <option value="fee schedule">fee schedule</option>
            `;

            ntLabel.appendChild(ntTitle);
            ntLabel.appendChild(ntSelect);
            header.insertBefore(ntLabel, exportComparisonButton);

            const expLabel = document.createElement('label');
            expLabel.style.display = 'flex';
            expLabel.style.alignItems = 'center';
            expLabel.style.gap = '8px';
            expLabel.style.flexWrap = 'wrap';
            expLabel.style.color = 'var(--text-muted)';
            expLabel.style.fontWeight = '600';

            const expCheckbox = document.createElement('input');
            expCheckbox.type = 'checkbox';
            expCheckbox.id = 'exclude-expired';

            const expText = document.createElement('span');
            expText.textContent = 'Exclude expired';

            expLabel.appendChild(expCheckbox);
            expLabel.appendChild(expText);
            header.insertBefore(expLabel, exportComparisonButton);
        }

        const fileInputs = [
            { inputId: 'source1-file', hintId: 'source1-file-hint' },
            { inputId: 'source2-file', hintId: 'source2-file-hint' },
            { inputId: 'source1-parts', hintId: 'source1-parts-hint' }
        ];

        fileInputs.forEach(({ inputId, hintId }) => {
            const input = document.getElementById(inputId);
            const hint = document.getElementById(hintId);
            if (!input || !hint) return;
            input.addEventListener('change', () => {
                if (!input.files || input.files.length === 0) {
                    hint.textContent = 'No file chosen';
                    return;
                }
                if (input.multiple && input.files.length > 1) {
                    hint.textContent = `${input.files.length} parts selected`;
                } else {
                    hint.textContent = input.files[0].name;
                }
            });
        });
        let currentComparison = null;
        const comparisonPagination = {
            higher_in_source1: 1,
            higher_in_source2: 1
        };
        const COMPARISON_PAGE_SIZE = 10;
        ensureComparisonRuleSelector();

        function setSourceReadyByNumber(sourceNum, isReady) {
            if (sourceNum === 1) {
                source1Ready = isReady;
            } else {
                source2Ready = isReady;
            }
        }

        function markSourceReadyByName(sourceName) {
            if (source1Data && source1Data.source_name === sourceName) {
                source1Ready = true;
            }
            if (source2Data && source2Data.source_name === sourceName) {
                source2Ready = true;
            }
        }

        async function uploadSource(sourceNum) {
            const nameInput = document.getElementById(`source${sourceNum}-name`);
            const fileInput = document.getElementById(`source${sourceNum}-file`);
            const urlInput = document.getElementById(`source${sourceNum}-url`);

            const sourceName = nameInput.value || `Source ${sourceNum}`;
            const file = fileInput.files[0];
            const url = urlInput.value;

            if (!file && !url) {
                showAlert('Please provide either a file or URL', 'error');
                return;
            }

            showLoading(true);

            const formData = new FormData();
            formData.append('source_name', sourceName);

            if (file) {
                formData.append('file', file);
            } else {
                formData.append('url', url);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const previewMessage = data.preview_message || null;
                    const cptPayload = data.cpt_data || data.cpt_preview || null;
                    const totalAvailable = data.cpt_count || (cptPayload ? Object.keys(cptPayload).length : 0);

                    if (sourceNum === 1) {
                        source1Data = data;
                        source1Ready = READY_SOURCE_TYPES.has(data.type);
                    } else {
                        source2Data = data;
                        source2Ready = READY_SOURCE_TYPES.has(data.type);
                    }

                    loadedSources.add(sourceName);

                    if (data.type === 'excel') {
                        showAlert(`${sourceName} loaded successfully! Found ${data.cpt_count} CPT codes from Excel.`, 'success');
                        displayExcelInfo(sourceNum, data);
                    } else if (data.type === 'csv') {
                        showAlert(`${sourceName} loaded successfully! Found ${data.cpt_count} CPT codes from CSV.`, 'success');
                        displayExcelInfo(sourceNum, data, 'CSV Upload', 'üßæ');
                        if (cptPayload) {
                            displayCPTData(cptPayload, data.source_name, previewMessage, totalAvailable);
                        }
                    } else if (data.type === 'direct_in_network_json') {
                        showAlert(`${sourceName} loaded successfully! Found ${data.cpt_count} CPT codes directly in this JSON.`, 'success');
                        displayDirectJsonInfo(sourceNum, data);
                        if (cptPayload) {
                            displayCPTData(cptPayload, data.source_name, previewMessage, totalAvailable);
                        }
                    } else if (data.type === 'large_file_pagination_recommended') {
                        // Large file - auto-load first page
                        showAlert(`${sourceName}: File is ${data.file_size_mb}MB. Auto-loading first page...`, 'success');
                        await loadPaginatedData(data.file_id, sourceName, sourceNum);
                    } else if (data.type === 'json_index') {
                        showAlert(`${sourceName} loaded successfully! Found ${data.file_count} in-network files. Click one of the sample files below to pull CPT pricing before comparing.`, 'success');
                        displaySourceInfo(sourceNum, data);
                    } else {
                        const fallbackMessage = data.message || 'Loaded file, but could not determine if it contains index URLs or CPT pricing.';
                        showAlert(fallbackMessage, 'warning');
                    }
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error uploading: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function uploadSource1Parts() {
            const partsInput = document.getElementById('source1-parts');
            const nameInput = document.getElementById('source1-name');
            const sourceName = nameInput.value || 'Source 1 (parts)';

            if (!partsInput.files || partsInput.files.length === 0) {
                showAlert('Select one or more split part files first.', 'error');
                return;
            }

            showLoading(true);
            try {
                for (const file of partsInput.files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('source_name', sourceName);
                    if (source1PartSession) {
                        formData.append('session_id', source1PartSession);
                    }

                    if (source2Ready && source2Data && source2Data.source_name) {
                        formData.append('baseline_source', source2Data.source_name);
                    }
                    formData.append('compare_rule', getSelectedComparisonRule());
                    formData.append('negotiated_type', getSelectedNegotiatedType());
                    formData.append('exclude_expired', getExcludeExpired() ? 'true' : 'false');

                    const response = await fetch('/upload_multipart_part', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (!data.success) {
                        showAlert(data.message || 'Error uploading part.', 'error');
                        return;
                    }
                    source1PartSession = data.session_id;
                    source1PartCount = data.part_count;
                    loadedSources.add(data.source_name);
                    document.getElementById('source1-parts-hint').textContent = `${source1PartCount} parts uploaded (${data.total_size_mb} MB)`;
                    if (data.comparison) {
                        displayComparison(data.comparison);
                    }
                    showAlert(data.message, 'success');
                }
            } catch (err) {
                showAlert('Error uploading parts: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function finalizeSource1Parts() {
            if (!source1PartSession) {
                showAlert('Upload at least one part before finalizing.', 'error');
                return;
            }

            const nameInput = document.getElementById('source1-name');
            const sourceName = nameInput.value || 'Source 1 (parts)';
            const formData = new FormData();
            formData.append('session_id', source1PartSession);
            formData.append('source_name', sourceName);

            // If Source 2 is ready, auto-use it as baseline for comparison
            if (source2Ready && source2Data && source2Data.source_name) {
                formData.append('baseline_source', source2Data.source_name);
            }
            formData.append('compare_rule', getSelectedComparisonRule());
            formData.append('negotiated_type', getSelectedNegotiatedType());
            formData.append('exclude_expired', getExcludeExpired() ? 'true' : 'false');

            showLoading(true);
            try {
                const response = await fetch('/finalize_multipart', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!data.success) {
                    showAlert(data.message || 'Unable to finalize parts.', 'error');
                    return;
                }

                // If comparison payload returned
                if (data.higher_in_source1 || data.higher_in_source2 || data.equal) {
                    data.source1 = data.source1 || sourceName;
                    displayComparison(data);
                    showAlert(`Compared split parts (${source1PartCount} parts) against ${data.source2}.`, 'success');
                    return;
                }

                // Otherwise treat as loaded source
                const previewMessage = data.preview_message || null;
                const cptPayload = data.cpt_data || data.cpt_preview || null;
                const totalAvailable = data.cpt_count || (cptPayload ? Object.keys(cptPayload).length : 0);

                source1Data = { source_name: data.source_name || sourceName, type: data.type || 'direct_in_network_json' };
                source1Ready = true;
                loadedSources.add(source1Data.source_name);

                if (cptPayload) {
                    displayCPTData(cptPayload, source1Data.source_name, previewMessage, totalAvailable);
                }
                showAlert(`Loaded split parts as ${source1Data.source_name} (${source1PartCount} parts). Ready for comparison.`, 'success');
            } catch (err) {
                showAlert('Error finalizing parts: ' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayExcelInfo(sourceNum, data, label = 'Excel', icon = 'üìä') {
            const resultsDiv = document.getElementById('results');
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'result-item';
            sourceDiv.id = `source${sourceNum}-info`;

            setSourceReadyByNumber(sourceNum, true);

            // Remove existing info for this source
            const existing = document.getElementById(`source${sourceNum}-info`);
            if (existing) existing.remove();

            sourceDiv.innerHTML = `
                <h4>${icon} ${data.source_name} (${label})</h4>
                <p><strong>CPT Codes Loaded:</strong> ${data.cpt_count}</p>
                <p style="color: #27ae60; font-weight: 600;">‚úì Ready for comparison</p>
            `;

            resultsDiv.appendChild(sourceDiv);
        }

        function displayDirectJsonInfo(sourceNum, data) {
            const resultsDiv = document.getElementById('results');
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'result-item';
            sourceDiv.id = `source${sourceNum}-info`;

            setSourceReadyByNumber(sourceNum, true);

            const existing = document.getElementById(`source${sourceNum}-info`);
            if (existing) existing.remove();

            sourceDiv.innerHTML = `
                <h4>ü©∫ ${data.source_name} (Direct In-Network JSON)</h4>
                <p><strong>CPT Codes Loaded:</strong> ${data.cpt_count}</p>
                <p style="color: #27ae60; font-weight: 600;">‚úì Ready for comparison</p>
            `;

            resultsDiv.appendChild(sourceDiv);
        }

        function displaySourceInfo(sourceNum, data) {
            const resultsDiv = document.getElementById('results');
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'result-item';
            sourceDiv.id = `source${sourceNum}-info`;

            setSourceReadyByNumber(sourceNum, false);

            // Remove existing info for this source
            const existing = document.getElementById(`source${sourceNum}-info`);
            if (existing) existing.remove();

            let html = `
                <h4>${data.source_name}</h4>
                <p><strong>In-Network Files:</strong> ${data.file_count}</p>
                <div class="url-list">
                    <p><strong>Sample Files (click to fetch pricing):</strong></p>
            `;

            const sampleUrls = data.sample_urls || [];
            sampleUrls.forEach((urlInfo, index) => {
                html += `
                    <div class="url-item" onclick="fetchPricing('${urlInfo.url}', '${data.source_name}')">
                        <strong>File ${index + 1}:</strong> ${urlInfo.description}
                        <small>${urlInfo.url.substring(0, 80)}...</small>
                    </div>
                `;
            });

            html += '</div>';
            sourceDiv.innerHTML = html;
            resultsDiv.appendChild(sourceDiv);
        }

        async function fetchPricing(url, sourceName) {
            showLoading(true);
            showAlert('Fetching pricing data... large files may take a minute the first time.', 'success');

            try {
                const response = await fetch('/fetch_pricing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, source_name: sourceName })
                });

                const data = await response.json();

                if (data.success) {
                    loadedSources.add(sourceName);
                    displayCPTData(data.cpt_data, sourceName, data.preview_message || null, data.cpt_count || (data.cpt_data ? Object.keys(data.cpt_data).length : null));
                    const cacheNote = data.cache_hit ? ' (loaded from local cache)' : '';
                    showAlert(`Loaded ${data.cpt_count} CPT codes from ${sourceName}. Ready for comparison!${cacheNote}`, 'success');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error fetching pricing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadPaginatedData(fileId, sourceName, sourceNum) {
            try {
                const formData = new FormData();
                formData.append('file_id', fileId);
                formData.append('page', 1);
                formData.append('page_size', 2000);  // Increased from 500 to 2000

                const response = await fetch('/load_paginated', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.cpt_data) {
                    // Mark source as ready
                    if (sourceNum === 1) {
                        source1Ready = true;
                    } else {
                        source2Ready = true;
                    }

                    // Display the loaded data
                    displayCPTData(data.cpt_data, sourceName,
                        `Showing page 1 (${data.cpt_count} codes). Large file loaded via pagination.`,
                        data.cpt_count);

                    showAlert(`‚úì ${sourceName}: Loaded first page (${data.cpt_count} codes). Ready for comparison!`, 'success');
                } else {
                    showAlert(`Error loading paginated data: ${data.message}`, 'error');
                }
            } catch (error) {
                showAlert('Error loading paginated data: ' + error.message, 'error');
            }
        }

        function displayCPTData(cptData, sourceName, previewMessage = null, totalAvailable = null) {
            if (!cptData) return;
            sourceCptState[sourceName] = {
                data: cptData,
                codes: Object.keys(cptData),
                currentPage: 1,
                previewMessage: previewMessage,
                previewOnly: Boolean(previewMessage),
                totalAvailable: totalAvailable || Object.keys(cptData).length
            };

            renderCptTable(sourceName);
            markSourceReadyByName(sourceName);
        }

        function renderCptTable(sourceName) {
            const state = sourceCptState[sourceName];
            if (!state) return;

            const previewMessage = state.previewMessage;
            const previewOnly = state.previewOnly;
            const totalAvailable = state.totalAvailable || state.codes.length;
            const totalCodes = state.codes.length;
            const totalPages = Math.max(1, Math.ceil(totalCodes / PAGE_SIZE));
            state.currentPage = Math.min(state.currentPage, totalPages);

            const startIndex = (state.currentPage - 1) * PAGE_SIZE;
            const currentCodes = state.codes.slice(startIndex, startIndex + PAGE_SIZE);

            const resultsDiv = document.getElementById('results');
            let tableDiv = document.getElementById(`cpt-data-${sourceName}`);
            if (!tableDiv) {
                tableDiv = document.createElement('div');
                tableDiv.className = 'result-item';
                tableDiv.id = `cpt-data-${sourceName}`;
                resultsDiv.appendChild(tableDiv);
            }

            let rows = '';
            currentCodes.forEach((code, index) => {
                const serial = startIndex + index + 1;
                const info = state.data[code];
                const rate = (info && info.rates && info.rates[0]) ? info.rates[0] : {};
                const desc = info && info.description ? info.description : 'No description';
                rows += `
                    <tr>
                        <td>${serial}</td>
                        <td><strong>${code}</strong></td>
                        <td>${desc.length > 80 ? desc.substring(0, 80) + '...' : desc}</td>
                        <td>$${rate.negotiated_rate ? Number(rate.negotiated_rate).toFixed(2) : 'N/A'}</td>
                        <td>${rate.billing_class || 'N/A'}</td>
                    </tr>
                `;
            });

            const previewNote = previewMessage ? `<div class="preview-note" style="margin-bottom: 10px; background: #fff4e6; border: 1px solid #fcd9bd; padding: 10px; border-radius: 8px; color: #92400e;">${previewMessage}</div>` : '';
            const previewTotals = previewOnly ? ` (Preview of ${totalAvailable.toLocaleString()})` : '';

            const summaryText = previewOnly
                ? `‚úì ${totalAvailable.toLocaleString()} CPT codes detected - showing the first ${totalCodes.toLocaleString()} for preview`
                : `‚úì ${totalCodes} codes loaded - Ready for comparison`;

            tableDiv.innerHTML = `
                <h4>CPT Codes from ${sourceName}</h4>
                <p style="color: #27ae60; font-weight: 600;">${summaryText}</p>
                ${previewNote}
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <p style="color: var(--text-muted); margin: 0;">Showing ${totalCodes ? startIndex + 1 : 0}-${Math.min(startIndex + PAGE_SIZE, totalCodes)} of ${totalCodes}${previewTotals}</p>
                    <button class="download-button" onclick="exportSourceData('${sourceName}')">‚¨á Download CSV</button>
                </div>
                <table class="cpt-table">
                    <thead>
                        <tr>
                            <th>S.No</th>
                            <th>CPT Code</th>
                            <th>Description</th>
                            <th>Negotiated Rate</th>
                            <th>Billing Class</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || '<tr><td colspan="5">No CPT codes found.</td></tr>'}
                    </tbody>
                </table>
                <div class="pagination-controls">
                    <button onclick="changeCptPage('${sourceName}', -1)" ${state.currentPage === 1 ? 'disabled' : ''}>‚¨Ö Previous</button>
                    <span>Page ${totalCodes ? state.currentPage : 0} of ${totalCodes ? totalPages : 0}</span>
                    <button onclick="changeCptPage('${sourceName}', 1)" ${state.currentPage === totalPages ? 'disabled' : ''}>Next ‚û°</button>
                </div>
            `;
        }

        function changeCptPage(sourceName, delta) {
            const state = sourceCptState[sourceName];
            if (!state) return;
            const totalPages = Math.max(1, Math.ceil(state.codes.length / PAGE_SIZE));
            const newPage = state.currentPage + delta;
            if (newPage < 1 || newPage > totalPages) return;
            state.currentPage = newPage;
            renderCptTable(sourceName);
        }

        async function exportSourceData(sourceName) {
            try {
                const response = await fetch(`/export_source_csv?source=${encodeURIComponent(sourceName)}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    showAlert(errorData.message || 'Failed to export data.', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sourceName}_cpt_pricing.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                showAlert(`Downloaded ${sourceName} CPT data.`, 'success');
            } catch (error) {
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        async function loadTestData() {
            showLoading(true);
            showAlert('Loading test insurance data...', 'success');

            try {
                const response = await fetch('/load_test_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source_name: 'Test Insurance' })
                });

                const data = await response.json();

                if (data.success) {
                    source1Data = { source_name: 'Test Insurance', type: 'json' };
                    loadedSources.add('Test Insurance');
                    displayCPTData(data.cpt_data, 'Test Insurance', null, data.cpt_count || Object.keys(data.cpt_data || {}).length);
                    showAlert(`Loaded ${data.cpt_count} CPT codes from Test Insurance. Ready for comparison!`, 'success');
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error loading test data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function compareSources() {
            if (!source1Data || !source2Data) {
                showAlert('Please load both sources first!', 'error');
                return;
            }

            if (!source1Ready || !source2Ready) {
                showAlert('Please load CPT pricing for both sources. Click a sample in-network file after uploading an index JSON (or load Excel/Test data) before comparing.', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch('/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source1: source1Data.source_name,
                        source2: source2Data.source_name,
                        compare_rule: getSelectedComparisonRule(),
                        negotiated_type: getSelectedNegotiatedType(),
                        exclude_expired: getExcludeExpired()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayComparison(data.comparison);
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Error comparing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function formatComparisonDescription(item, comparison) {
            const truncate = (text) => {
                if (!text) return 'No description';
                return text.length > 60 ? `${text.substring(0, 57)}...` : text;
            };

            const desc1 = truncate(item.source1_description);
            const desc2 = truncate(item.source2_description);

            if (item.descriptions_match || !item.source2_description) {
                return `<span style="color: var(--text-muted);">${desc1}</span>`;
            }

            return `
                <div style="color: var(--text-muted);"><strong>${comparison.source1}:</strong> ${desc1}</div>
                <div style="color: var(--text-muted); opacity: 0.8;"><strong>${comparison.source2}:</strong> ${desc2}</div>
            `;
        }

        function formatCurrency(value) {
            const amount = Number(value || 0);
            return '$' + amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function resetComparisonPagination() {
            Object.keys(comparisonPagination).forEach(key => {
                comparisonPagination[key] = 1;
            });
        }

        function displayComparison(comparison) {
            currentComparison = comparison;
            resetComparisonPagination();
            if (exportComparisonButton) {
                exportComparisonButton.disabled = false;
            }
            renderComparisonResults();
            if (!comparison || !comparison.incremental) {
                showAlert('Comparison complete!', 'success');
            }
        }

        function renderComparisonResults() {
            if (!currentComparison) return;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            const compDiv = document.createElement('div');
            compDiv.className = 'result-item';
            compDiv.id = 'comparison-results';
            resultsDiv.appendChild(compDiv);

            const higherTotal = formatCurrency(currentComparison.total_higher_in_source1_amount);
            const lowerTotal = formatCurrency(currentComparison.total_higher_in_source2_amount);

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <h3 style="color: var(--text-main); font-size: 1.5rem;">üìä Pricing Comparison Results</h3>
                    <button class="download-button" onclick="exportComparisonData()">‚¨á Export Comparison CSV</button>
                </div>
                <div class="stat-grid">
                    <div class="stat-card">
                        <h4 style="color: var(--primary);">Total Compared</h4>
                        <p class="stat-value">${currentComparison.total_compared}</p>
                    </div>
                    ${currentComparison.parts_processed != null ? `
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted);">Parts Processed</h4>
                        <p class="stat-value">${currentComparison.parts_processed}</p>
                    </div>
                    ` : ''}
                    <div class="stat-card">
                        <h4 style="color: var(--danger);">Higher in ${currentComparison.source1}</h4>
                        <p class="stat-value" style="background: linear-gradient(to bottom, #fca5a5, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${(currentComparison.higher_in_source1_count != null) ? currentComparison.higher_in_source1_count : currentComparison.higher_in_source1.length}</p>
                        <p style="margin-top: 10px; color: var(--text-muted);">Total Impact: <strong>${higherTotal}</strong></p>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: var(--success);">Lower in ${currentComparison.source1}</h4>
                        <p class="stat-value" style="background: linear-gradient(to bottom, #86efac, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${(currentComparison.higher_in_source2_count != null) ? currentComparison.higher_in_source2_count : currentComparison.higher_in_source2.length}</p>
                        <p style="margin-top: 10px; color: var(--text-muted);">Potential Savings: <strong>${lowerTotal}</strong></p>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: var(--text-muted);">Equal Pricing</h4>
                        <p class="stat-value" style="background: linear-gradient(to bottom, #e2e8f0, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${(currentComparison.equal_count != null) ? currentComparison.equal_count : currentComparison.equal.length}</p>
                    </div>
                </div>
            `;

            html += buildComparisonTable('higher_in_source1', `üî¥ Higher Prices in ${currentComparison.source1}`, currentComparison.source1, currentComparison.source2, false);
            html += buildComparisonTable('higher_in_source2', `üü¢ Lower Prices in ${currentComparison.source1} (Better Deal!)`, currentComparison.source1, currentComparison.source2, true);

            html += buildComparisonTable('equal', `Equal Pricing (${currentComparison.source1} vs ${currentComparison.source2})`, currentComparison.source1, currentComparison.source2, false);
            compDiv.innerHTML = html;
        }

        function buildComparisonTable(category, title, source1Label, source2Label, invertDifference) {
            const items = (currentComparison && currentComparison[category]) || [];
            if (!items.length) return '';

            if (!comparisonPagination[category]) {
                comparisonPagination[category] = 1;
            }

            const page = comparisonPagination[category];
            const totalPages = Math.max(1, Math.ceil(items.length / COMPARISON_PAGE_SIZE));
            const startIndex = (page - 1) * COMPARISON_PAGE_SIZE;
            const slice = items.slice(startIndex, startIndex + COMPARISON_PAGE_SIZE);

            let rows = '';
            slice.forEach((item, index) => {
                const serial = startIndex + index + 1;
                const source1Rate = Number(item.source1_rate || 0);
                const source2Rate = Number(item.source2_rate || 0);
                const diffValue = Number(item.difference || 0);
                const percent = Number(item.percent_difference || 0);
                const diffLabel = invertDifference ? `-$${Math.abs(diffValue).toFixed(2)}` : `+$${diffValue.toFixed(2)}`;
                const diffColor = invertDifference ? 'var(--success)' : 'var(--danger)';

                rows += `
                    <tr>
                        <td>${serial}</td>
                        <td><strong style="color: var(--text-main);">${item.code}${item.billing_class ? ` (${item.billing_class})` : ''}${item.modifiers && item.modifiers.length ? ` [${item.modifiers.join(',')}]` : ''}</strong></td>
                        <td>${formatComparisonDescription(item, currentComparison)}</td>
                        <td class="${invertDifference ? 'price-lower' : 'price-higher'}">$${source1Rate.toFixed(2)}</td>
                        <td class="${invertDifference ? 'price-higher' : 'price-lower'}">$${source2Rate.toFixed(2)}</td>
                        <td><span style="color: ${diffColor};">${diffLabel}</span> <span style="font-size: 0.8em; opacity: 0.7;">(${percent.toFixed(1)}%)</span></td>
                    </tr>
                `;
            });

            return `
                <h4 style="color: ${invertDifference ? 'var(--success)' : 'var(--danger)'}; margin-top: 30px; margin-bottom: 15px;">${title}</h4>
                <table class="cpt-table">
                    <thead>
                        <tr>
                            <th>S.No</th>
                            <th>CPT Code</th>
                            <th>Description</th>
                            <th>${source1Label}</th>
                            <th>${source2Label}</th>
                            <th>${invertDifference ? 'Savings' : 'Difference'}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
                <div class="pagination-controls">
                    <button onclick="changeComparisonPage('${category}', -1)" ${page === 1 ? 'disabled' : ''}>‚¨Ö Previous</button>
                    <span>Page ${page} of ${totalPages}</span>
                    <button onclick="changeComparisonPage('${category}', 1)" ${page === totalPages ? 'disabled' : ''}>Next ‚û°</button>
                </div>
            `;
        }

        function changeComparisonPage(category, delta) {
            if (!currentComparison || !currentComparison[category]) return;
            const totalPages = Math.max(1, Math.ceil(currentComparison[category].length / COMPARISON_PAGE_SIZE));
            const newPage = (comparisonPagination[category] || 1) + delta;
            if (newPage < 1 || newPage > totalPages) return;
            comparisonPagination[category] = newPage;
            renderComparisonResults();
        }

        async function exportComparisonData() {
            try {
                let response;

                if (currentComparison && currentComparison.incremental && currentComparison.session_id) {
                    const params = new URLSearchParams({
                        session_id: currentComparison.session_id
                    });
                    response = await fetch(`/export_incremental_comparison_csv?${params.toString()}`);
                } else {
                    if (!source1Data || !source2Data) {
                        showAlert('Load both sources before exporting.', 'error');
                        return;
                    }

                    const params = new URLSearchParams({
                        source1: source1Data.source_name,
                        source2: source2Data.source_name,
                        compare_rule: getSelectedComparisonRule(),
                        negotiated_type: getSelectedNegotiatedType(),
                        exclude_expired: getExcludeExpired() ? 'true' : 'false'
                    });

                    response = await fetch(`/export_comparison_csv?${params.toString()}`);
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    showAlert(errorData.message || 'Failed to export comparison.', 'error');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                if (currentComparison && currentComparison.incremental && currentComparison.session_id) {
                    a.download = `${(currentComparison.source1 || 'Source1')}_vs_${(currentComparison.source2 || 'Source2')}_incremental_${currentComparison.session_id}.csv`;
                } else {
                    a.download = `${source1Data.source_name}_vs_${source2Data.source_name}_comparison.csv`;
                }
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                showAlert('Comparison CSV downloaded.', 'success');
            } catch (error) {
                showAlert('Error exporting comparison: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.innerHTML = '';
            alertsDiv.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }
    </script>
</body>

</html>